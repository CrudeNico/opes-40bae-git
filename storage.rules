rules_version = '2';
service firebase.storage {
  match /b/{bucket}/o {
    // Helper function to check if user is authenticated
    function isAuthenticated() {
      return request.auth != null;
    }
    
    // Helper function to check if user is admin
    // We check the user document once and evaluate all conditions
    function isAdmin() {
      return isAuthenticated() && 
             firestore.exists(/databases/(default)/documents/users/$(request.auth.uid)) &&
             (
               // Check statuses array for 'Admin'
               (firestore.get(/databases/(default)/documents/users/$(request.auth.uid)).data.get('statuses', []).hasAny(['Admin'])) ||
               // Check isAdmin boolean
               firestore.get(/databases/(default)/documents/users/$(request.auth.uid)).data.get('isAdmin', false) == true ||
               // Check isAdmin array for 'Admin'
               (firestore.get(/databases/(default)/documents/users/$(request.auth.uid)).data.get('isAdmin', []).hasAny(['Admin']))
             );
    }

    // User profile images
    match /profile-images/{userId}/{imageName} {
      // Users can read their own profile images
      allow read: if isAuthenticated() && request.auth.uid == userId;
      // Users can upload their own profile images
      allow write: if isAuthenticated() && request.auth.uid == userId;
      // Admins can read and write any profile image
      allow read, write: if isAdmin();
    }

    // News images
    match /news/{imageName} {
      // All authenticated users can read news images
      allow read: if isAuthenticated();
      // Allow authenticated users to upload news images
      // Note: Admin check via Firestore in Storage rules has limitations
      // Security is enforced at the application level (only admins can access the admin panel)
      allow write: if isAuthenticated();
    }
    
    // Support images - users can upload to their own folder, admins can upload to any user's folder, all authenticated users can read
    // Note: Admin check via Firestore in Storage rules has limitations
    // Security is enforced at the application level (only admins can access the admin panel)
    match /support-images/{userId}/{fileName} {
      allow read: if isAuthenticated();
      allow write: if isAuthenticated();
    }
    
    // Support files - users can upload to their own folder, admins can upload to any user's folder, all authenticated users can read
    // Note: Admin check via Firestore in Storage rules has limitations
    // Security is enforced at the application level (only admins can access the admin panel)
    match /support-files/{userId}/{fileName} {
      allow read: if isAuthenticated();
      allow write: if isAuthenticated();
    }

    // Learning content PDFs
    match /learning/{moduleId}/{subModuleId}/{fileName} {
      allow read: if isAuthenticated();
      allow write: if isAuthenticated();
    }

    // Community images
    match /community-images/{userId}/{fileName} {
      allow read: if isAuthenticated();
      allow write: if isAuthenticated();
    }

    // Community files
    match /community-files/{userId}/{fileName} {
      allow read: if isAuthenticated();
      allow write: if isAuthenticated();
    }

    // Weekly reports PDFs
    match /weekly-reports/{reportId}/{fileName} {
      allow read: if isAuthenticated();
      allow write: if isAuthenticated();
    }

    // Admin emails attachments
    // Note: Admin check via Firestore in Storage rules has limitations
    // Security is enforced at the application level (only admins can access the admin panel)
    match /admin-emails/{fileName} {
      allow read: if isAuthenticated();
      allow write: if isAuthenticated();
    }

    // Careers images - public read access for website images
    match /careers/{fileName} {
      allow read: if true; // Public read access - no authentication required
      allow write: if isAuthenticated(); // Only authenticated users can upload
    }

    // Homepage images - public read access for website images
    match /homepage/{fileName} {
      allow read: if true; // Public read access - no authentication required
      allow write: if isAuthenticated(); // Only authenticated users can upload
    }

    // Contact images - public read access for website images
    match /contact/{fileName} {
      allow read: if true; // Public read access - no authentication required
      allow write: if isAuthenticated(); // Only authenticated users can upload
    }

    // Our Team images - public read access for website images
    match /our-team/{fileName} {
      allow read: if true; // Public read access - no authentication required
      allow write: if isAuthenticated(); // Only authenticated users can upload
    }

    // Partners images - public read access for website images
    match /partners/{fileName} {
      allow read: if true; // Public read access - no authentication required
      allow write: if isAuthenticated(); // Only authenticated users can upload
    }

    // Portfolio Models images - public read access for website images
    match /Portfolio-Models/{fileName} {
      allow read: if true; // Public read access - no authentication required
      allow write: if isAuthenticated(); // Only authenticated users can upload
    }

    // Risk Management images - public read access for website images
    match /Risk-Management/{fileName} {
      allow read: if true; // Public read access - no authentication required
      allow write: if isAuthenticated(); // Only authenticated users can upload
    }

    // Crude Oil Strategies images - public read access for website images
    match /Crude-Oil-Strategies/{fileName} {
      allow read: if true; // Public read access - no authentication required
      allow write: if isAuthenticated(); // Only authenticated users can upload
    }

    // Investment Calculator images - public read access for website images
    match /Investment-Calculator/{fileName} {
      allow read: if true; // Public read access - no authentication required
      allow write: if isAuthenticated(); // Only authenticated users can upload
    }

    // Execution Technology images - public read access for website images
    match /Execution-Technology/{fileName} {
      allow read: if true; // Public read access - no authentication required
      allow write: if isAuthenticated(); // Only authenticated users can upload
    }
    match /Execution-&-Technology/{fileName} {
      allow read: if true; // Public read access - no authentication required
      allow write: if isAuthenticated(); // Only authenticated users can upload
    }

    // Performance Tracking PDFs and images - public read access for website files
    match /Performance-Tracking/{fileName} {
      allow read: if true; // Public read access - no authentication required
      allow write: if isAuthenticated(); // Only authenticated users can upload
    }

    // Onboarding images - public read access for website images
    match /Onboarding/{fileName} {
      allow read: if true; // Public read access - no authentication required
      allow write: if isAuthenticated(); // Only authenticated users can upload
    }

    // Managed Portfolios images - public read access for website images
    match /Managed-Portfolios/{fileName} {
      allow read: if true; // Public read access - no authentication required
      allow write: if isAuthenticated(); // Only authenticated users can upload
    }

    // Macro Insights images - public read access for website images
    match /Macro-Insights/{fileName} {
      allow read: if true; // Public read access - no authentication required
      allow write: if isAuthenticated(); // Only authenticated users can upload
    }

    // Compliance images - public read access for website images
    match /Compliance/{fileName} {
      allow read: if true; // Public read access - no authentication required
      allow write: if isAuthenticated(); // Only authenticated users can upload
    }

    // Risk Guidance images - public read access for website images
    match /Risk-Guidance/{fileName} {
      allow read: if true; // Public read access - no authentication required
      allow write: if isAuthenticated(); // Only authenticated users can upload
    }

    // Learning images - public read access for website images
    match /Learning/{fileName} {
      allow read: if true; // Public read access - no authentication required
      allow write: if isAuthenticated(); // Only authenticated users can upload
    }

    // Section images - public read access for navigation dropdown images
    match /Section/{fileName} {
      allow read: if true; // Public read access - no authentication required
      allow write: if isAuthenticated(); // Only authenticated users can upload
    }

    // Favicon - public read access for website favicon
    match /Favicon/{fileName} {
      allow read: if true; // Public read access - no authentication required
      allow write: if isAuthenticated(); // Only authenticated users can upload
    }

    // Default: deny all other access
    match /{allPaths=**} {
      allow read, write: if false;
    }
  }
}

