rules_version = '2';
service firebase.storage {
  match /b/{bucket}/o {
    // Helper function to check if user is authenticated
    function isAuthenticated() {
      return request.auth != null;
    }
    
    // Helper function to check if user is admin
    // We check the user document once and evaluate all conditions
    function isAdmin() {
      return isAuthenticated() && 
             firestore.exists(/databases/(default)/documents/users/$(request.auth.uid)) &&
             (
               // Check statuses array for 'Admin'
               (firestore.get(/databases/(default)/documents/users/$(request.auth.uid)).data.get('statuses', []).hasAny(['Admin'])) ||
               // Check isAdmin boolean
               firestore.get(/databases/(default)/documents/users/$(request.auth.uid)).data.get('isAdmin', false) == true ||
               // Check isAdmin array for 'Admin'
               (firestore.get(/databases/(default)/documents/users/$(request.auth.uid)).data.get('isAdmin', []).hasAny(['Admin']))
             );
    }

    // User profile images
    match /profile-images/{userId}/{imageName} {
      // Users can read their own profile images
      allow read: if isAuthenticated() && request.auth.uid == userId;
      // Users can upload their own profile images
      allow write: if isAuthenticated() && request.auth.uid == userId;
      // Admins can read and write any profile image
      allow read, write: if isAdmin();
    }

    // News images
    match /news/{imageName} {
      // All authenticated users can read news images
      allow read: if isAuthenticated();
      // Allow authenticated users to upload news images
      // Note: Admin check via Firestore in Storage rules has limitations
      // Security is enforced at the application level (only admins can access the admin panel)
      allow write: if isAuthenticated();
    }
    
    // Support images - users can upload to their own folder, admins can upload to any user's folder, all authenticated users can read
    // Note: Admin check via Firestore in Storage rules has limitations
    // Security is enforced at the application level (only admins can access the admin panel)
    match /support-images/{userId}/{fileName} {
      allow read: if isAuthenticated();
      allow write: if isAuthenticated();
    }
    
    // Support files - users can upload to their own folder, admins can upload to any user's folder, all authenticated users can read
    // Note: Admin check via Firestore in Storage rules has limitations
    // Security is enforced at the application level (only admins can access the admin panel)
    match /support-files/{userId}/{fileName} {
      allow read: if isAuthenticated();
      allow write: if isAuthenticated();
    }

    // Learning content PDFs
    match /learning/{moduleId}/{subModuleId}/{fileName} {
      allow read: if isAuthenticated();
      allow write: if isAuthenticated();
    }

    // Community images
    match /community-images/{userId}/{fileName} {
      allow read: if isAuthenticated();
      allow write: if isAuthenticated();
    }

    // Community files
    match /community-files/{userId}/{fileName} {
      allow read: if isAuthenticated();
      allow write: if isAuthenticated();
    }

    // Weekly reports PDFs
    match /weekly-reports/{reportId}/{fileName} {
      allow read: if isAuthenticated();
      allow write: if isAuthenticated();
    }

    // Default: deny all other access
    match /{allPaths=**} {
      allow read, write: if false;
    }
  }
}

